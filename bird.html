<html>
    <head>
        <title>Flappy Bird</title>
    </head>
    <body>
        <script src="js/bird.js" type="text/javascript"></script>
        <script src="js/world.js" type="text/javascript"></script>

        <script src="js/pixi.js" type="text/javascript"></script>
        <script src="js/pixi-layers.js" type="text/javascript"></script>
        <script src="js/matter.js" type="text/javascript"></script>
        <script>
            const gWidth = 288,
                  gHeight = 512;

            let Engine = Matter.Engine,
                World = Matter.World,
                Bodies = Matter.Bodies,
                Body = Matter.Body;

            let engine;

            engine = Engine.create();

            const app = new PIXI.Application(gWidth, gHeight, {backgroundColor : 0x1099bb});
            document.body.appendChild(app.view);

            let skyGroup = new PIXI.display.Group(0, true);
            let pipeGroup = new PIXI.display.Group(1, true);
            let groundGroup = new PIXI.display.Group(2, true);
            let birdGroup= new PIXI.display.Group(3, true);

            app.stage = new PIXI.display.Stage();
            app.stage.group.enableSort = true;
            app.stage.addChild(new PIXI.display.Layer(skyGroup));
            app.stage.addChild(new PIXI.display.Layer(pipeGroup));
            app.stage.addChild(new PIXI.display.Layer(groundGroup));
            app.stage.addChild(new PIXI.display.Layer(birdGroup));

            let bird,
                ground,
                ground2,
                sky,
                sky2,
                pipeup,
                pipedown;
            
            function setup() {
                app.stop();
                
                PIXI.loader
                    .add('bird')
                    .load(onAssetsLoaded);
            }

            class Pipe {
                constructor(up, y) {
                    this.pipeWidth = 30 * 1.6;
                    this.pipeHeight = 160 * 1.6;

                    let yPos = 0;

                    // create a new Sprite from an image patha
                    if (up === true) {
                        this.pipe = PIXI.Sprite.fromImage('assets/world/PipeUp.png')
                        yPos = getRandomArbitrary(282, 457);
                        //yPos = 457;
                    } else {
                        this.pipe = PIXI.Sprite.fromImage('assets/world/PipeDown.png')
                        yPos = y - 350;
                    }

                    // center the sprite's anchor point
                    this.pipe.anchor.set(0.5);

                    this.pipe.width = this.pipeWidth;
                    this.pipe.height = this.pipeHeight;

                    // moves the sprite on the screen
                    this.pipe.x = app.renderer.width;
                    this.pipe.y = yPos;

                    this.body = Bodies.rectangle(this.pipe.x, this.pipe.y, this.pipeWidth, this.pipeHeight, { isStatic: true});
                }
                
                addPipe() {
                    app.stage.addChild(this.pipe);
                    World.add(engine.world, this.body);
                }

                getPipeY() {
                    return this.pipe.y;
                }
            }

            function getRandomArbitrary(min, max) {
                return Math.random() * (max - min) + min;
            }

            function onAssetsLoaded(loader) {
                const objScale = 1.2;

                let groundH = 112 * 1.2,
                    groundW = 336 * 1.2;
                let skyH = 109 * 1.2,
                    skyW = 276 * 1.2;

                let assetpath2 = 'assets/world/sky.png';
                sky = new WorldA(assetpath2, skyW, skyH, app.renderer.height - groundH - skyH, gHeight, false);
                sky2 = new WorldA(assetpath2, skyW, skyH, app.renderer.height - groundH - skyH, gHeight, false);
                sky.asset.parentGroup = skyGroup;
                sky2.asset.parentGroup = skyGroup;
                sky.addAsset();
                sky2.addAsset();

                //bunny.parentGroup = greenGroup;

                pipeup = new Pipe(true);
                pipeup.pipe.parentGroup = pipeGroup;
                pipeup.addPipe();

                pipedown = new Pipe(false, pipeup.getPipeY());
                pipedown.pipe.parentGroup = pipeGroup;
                pipedown.addPipe();

                let assetpath = 'assets/world/land.png';
                ground = new WorldA(assetpath, groundW, groundH, app.renderer.height - groundH, gHeight, true);
                ground2 = new WorldA(assetpath, groundW, groundH, app.renderer.height - groundH, gHeight, true);
                ground.asset.parentGroup = groundGroup;
                ground2.asset.parentGroup = groundGroup;
                ground.addAsset();
                ground2.addAsset();

                bird = new Bird();
                bird.bird.parentGroup = birdGroup;
                bird.addBird();

                app.start();
            }

            let pos = 0;
            function run() {
                Engine.run(engine);

                // Listen for animate update
                app.ticker.add(function(delta) {
                    pos += 1;

                    bird.bird.position = bird.body.position;

                    sky.asset.x = -(pos * 0.6);
                    sky.asset.x %= sky.asset.width * 2;
                    if (sky.asset.x < 0) {
                        sky.asset.x += sky.asset.width * 2;
                    }
                    sky.asset.x -= sky.asset.width;
                
                    sky2.asset.x = -(pos * 0.6) + sky2.asset.width;
                    sky2.asset.x %= sky2.asset.width * 2;
                    if(sky2.asset.x < 0) {
                        sky2.asset.x += sky2.asset.width * 2;
                    }
                    sky2.asset.x -= sky2.asset.width;

                    ground.asset.x = -(pos * 0.6);
                    ground.asset.x %= ground.asset.width * 2;
                    if (ground.asset.x < 0) {
                        ground.asset.x += ground.asset.width * 2;
                    }
                    ground.asset.x -= ground.asset.width;

                    
                    ground2.asset.x = -(pos * 0.6) + ground2.asset.width;
                    ground2.asset.x %= ground2.asset.width * 2;
                    if (ground2.asset.x < 0) {
                        ground2.asset.x += ground2.asset.width * 2;
                    }
                    ground2.asset.x -= ground2.asset.width;

                    if (pipeup.body.position.x < -30) {
                        pipeup = new Pipe(true);
                        pipeup.addPipe();
                    }
                    let t = { x: -2, y: 0 };
                    Body.translate(pipeup.body, t);
                    pipeup.pipe.position = pipeup.body.position;

                    if (pipedown.body.position.x < -30) {
                        pipedown = new Pipe(false, pipeup.getPipeY());
                        pipedown.addPipe();
                    }
                    Body.translate(pipedown.body, t);
                    pipedown.pipe.position = pipedown.body.position;
                });
            }

            function addEventListeners() {
                window.addEventListener('keydown', handleKeydown, false);
            }

            function handleKeydown(event) {
                if (event.keyCode === 32) {
                    bird.bumpBird();
                }
            }

            window.onload = init();

            function init() {
                setup();
                addEventListeners();
                run();
            }

        </script>
    </body>
</html>

